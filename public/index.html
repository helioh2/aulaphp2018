<html>
    <head>
        <title>Listar Clientes</title>        
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <script src="http://www.w3schools.com/lib/w3data.js"></script>
        <!-- <script src="./node_modules/jquery/dist/jquery.min.js"></script> -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-route.js"></script>
        <!-- <script src="itens.js"></script> -->
    </head>
   
    <body ng-app="clientesApp">

        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-default ">
                    <div class="navbar-header">
                        <h3 class="text-muted"><strong>Cadastro de Clientes</strong></h3>
                    </div>                        
                    <div class="text-right">
                        <a href="backend/logoff.php" ><span class="glyphicon glyphicon-off"></span></a>
                    </div>
                </nav>
            </div>
        </div>

        <p><a href="/">Main</a></p>

        <ng-view></ng-view>

        <script>
            var app = angular.module('clientesApp', ["ngRoute"]);

            app.config(function($routeProvider) {
                $routeProvider
                .when("/", {
                    templateUrl: "listar.html",
                    controller: "listarCtrl"
                })
                .when("/alterar/:id", {
                    templateUrl: "formAlterar.html",
                    controller: "alterarCtrl"
                })
                .when("/inserir", {
                    templateUrl: "formAlterar.html",
                    controller: "inserirCtrl"
                });
            })

            app.controller('listarCtrl', function($scope, $http, $interval) {
                
                //FUNCAO QUE ATUALIZA LISTA
                $scope.refresh = function() {
                    $http.get("/clientes")
                    .then(function success(response) {
                        $scope.clientes = response.data
                    }, function error(response) {
                        $scope.clientes = [{nome: "Erro"}]
                    });
                }
                
                $scope.delete = function(id) {
                    $http.delete("/clientes/"+id, 
                                { params: { id: id } })
                    .then(function success(response) {
                        alert("chegou")
                        $scope.clientes = $scope.clientes.filter(
                            (item) => item.id != id
                        )
                        alert($scope.clientes)
                    });
                }

                $scope.refresh()

                //ATUALIZA A CADA 2 SEGUNDOS
                $interval(function () {
                    $scope.refresh()
                }, 2000);
                
            });

            app.controller('alterarCtrl', function($scope, $http, 
                                                $routeParams, $location) {
                
                //FUNÇÕES PARA CONVERSÃO DE TIPOS                                    
                $scope.fixTypes = function() {
                    $scope.cliente.idade = parseInt($scope.cliente.idade)
                    $scope.cliente.dataNascimento = new Date($scope.cliente.dataNascimento)
                                                   
                }
                $scope.fixDateForBackend = function() {
                    $scope.cliente.dataNascimento = $scope.cliente.dataNascimento
                                                    .toISOString().slice(0,10);
                }
              
                //CARREGA CLIENTE AO ENTRAR NO FORM
                $http.get("/clientes/"+$routeParams.id)
                .then(function success(response) {                
                    $scope.cliente = response.data[0]
                    $scope.fixTypes();
                }, function error(response) {
                    $scope.cliente = {nome: "Erro"}
                });
                
                //FUNÇÃO DE SUBMETER FORM
                $scope.submitForm = function() {
                    $scope.fixDateForBackend()
                    $http.put("/clientes/"+$scope.cliente._id,
                                        $scope.cliente).
                    then(function success(response) {
                        $location.path("/")
                    });
                }
            });

            app.controller('inserirCtrl', function($scope, $http, $location) {
                
                $scope.fixDateForBackend = function() {
                    $scope.cliente.dataNascimento = $scope.cliente.dataNascimento
                                                .toISOString().slice(0,10);
                }

                $scope.submitForm = function() {
                    $scope.fixDateForBackend()
                    $http.post("/clientes", $scope.cliente).
                    then(function success(response) {
                        $location.path("/")
                    });
                }
            });

            
        </script>
    </body>
</html>







