<html>
    <head>
        <title>Listar Clientes</title>        
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <script src="http://www.w3schools.com/lib/w3data.js"></script>
        <!-- <script src="./node_modules/jquery/dist/jquery.min.js"></script> -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-route.js"></script>
        <!-- <script src="itens.js"></script> -->
    </head>
   
    <body ng-app="clientesApp">

        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-default ">
                    <div class="navbar-header">
                        <h3 class="text-muted"><strong>Cadastro de Clientes</strong></h3>
                    </div>                        
                    <div class="text-right">
                        <a href="backend/logoff.php" ><span class="glyphicon glyphicon-off"></span></a>
                    </div>
                </nav>
            </div>
        </div>

        <p><a href="/">Main</a></p>

        <ng-view></ng-view>

        <script>
            var app = angular.module('clientesApp', ["ngRoute"]);

            app.config(function($routeProvider) {
                $routeProvider
                .when("/", {
                    templateUrl: "listar.html",
                    controller: "listarCtrl"
                })
                .when("/alterar/:id", {
                    templateUrl: "formAlterar.html",
                    controller: "alterarCtrl"
                })               
                .when("/inserir", {
                    templateUrl: "formAlterar.html",
                    controller: "inserirCtrl"
                })
                .when("/listarPedidos/:id", {
                    templateUrl: "listarPedidos.html",
                    controller: "listarPedidosCtrl"
                })
                .when("/novoPedido/:id", {
                    templateUrl: "novoPedido.html",
                    controller: "novoPedidoCtrl"
                });
            })

            app.service('clientesService', function($http) {
                var clientes = [];

                var loadClientes = function(callback) {
                    $http.get("/clientes")
                    .then(function success(response) {
                        clientes = response.data;
                        callback(clientes);
                    }, function error(response) {
                        clientes = [{nome: "Erro"}];
                    });                   
                };

                var getClientes = function(){
                    return clientes;
                };

                var deleteCliente = function(id){
                    clientes = clientes.filter((cliente) => cliente._id != id);
                    return clientes;
                }

                var getCliente = function(id) {
                    return clientes.find((cliente) => cliente._id == id);
                }

                var addCliente = function(cliente) {
                    clientes.push(cliente);
                }

                return {
                    loadClientes: loadClientes,
                    getClientes: getClientes,
                    deleteCliente: deleteCliente,
                    getCliente: getCliente,
                    addCliente: addCliente
                };

            });

            app.controller('listarCtrl', function($scope, $http, $interval, clientesService) {
                
                //FUNCAO QUE ATUALIZA LISTA
                $scope.refresh = function() {
                    clientesService.loadClientes(function(clientes) {
                        $scope.clientes = clientes;
                    });                 
                }

                $scope.delete = function(id) {
                    $http.delete("/clientes/"+id)
                    .then(function success(response) {
                        $scope.clientes = clientesService.deleteCliente(id);
                    });
                }

                $scope.refresh()

                //ATUALIZA A CADA 2 SEGUNDOS
                $interval(function () {
                    $scope.refresh()
                }, 2000);
                
            });

             app.controller('listarPedidosCtrl', function($scope, $http, $routeParams, clientesService) {
                
                $scope.cliente = clientesService.getCliente($routeParams.id)
                
                //FUNCAO QUE ATUALIZA LISTA
                $scope.refresh = function() {
                    $http.get("/clientes/"+$scope.cliente._id+"/pedidos")
                    .then(function success(response) {
                        $scope.pedidos = response.data; 
                    }, function error(response) {
                        $scope.pedidos = [{nome: "Erro"}];
                    });                   
                }
                               
                $scope.delete = function(id) {
                    $http.delete("/clientes/"+$scope.cliente._id+"/pedidos/"+id)
                    .then(function success(response) {
                        $scope.pedidos = $scope.pedidos.filter(
                            (item) => item.id != id
                        )
                    });
                }

                $scope.refresh()
                
            });


            app.controller('alterarCtrl', function($scope, $http, 
                                                $routeParams, $location, clientesService) {
              
                //CARREGA CLIENTE AO ENTRAR NO FORM
                $scope.clientes = clientesService.getCliente($routeParams.id);
                
                //FUNÇÃO DE SUBMETER FORM
                $scope.submitForm = function() {
                    $http.put("/clientes/"+$scope.cliente._id,
                                        $scope.cliente).
                    then(function success(response) {
                        $location.path("/")
                    });
                }
            });

            app.controller('inserirCtrl', function($scope, $http, $location, clientesService) {
                
                $scope.submitForm = function() {
                    $http.post("/clientes", $scope.cliente).
                    then(function success(response) {
                        clientesService.addCliente($scope.cliente)
                        $location.path("/")
                    });
                }
            });

            app.controller('novoPedidoCtrl', function($scope, $http, $location, clientesService) {
                
                $scope.clientes = clientesService.getCliente($routeParams.id);

                $scope.loadItems = function () {
                    $http.get("/itens").
                    then(function success(response) {
                        $scope.itens = response.data;
                    });
                }
                
                $scope.loadItems();

                $scope.submitForm = function() {
                    $http.post("/clientes", $scope.cliente).
                    then(function success(response) {
                        clientesService.addCliente($scope.cliente)
                        $location.path("/")
                    });
                }
            });

            
        </script>
    </body>
</html>







